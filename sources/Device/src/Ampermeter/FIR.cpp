// 2022/11/15 16:06:51 (c) Aleksandr Shevchenko e-mail : Sasha7b9@tut.by
#include "defines.h"
#include "Ampermeter/FIR.h"


/*
    Filter type: Low Pass
    Filter model: Chebyshev
    Filter order: 2
    Sampling Frequency: 4 KHz
    Cut Frequency: 1.000000 KHz
    Pass band Ripple: 1.000000 dB
    Coefficents Quantization: float
    
    Z domain Zeros
    z = -1.000000 + j 0.000000
    z = -1.000000 + j 0.000000
    
    Z domain Poles
    z = -0.032032 + j -0.559413
    z = -0.032032 + j 0.559413
*/


int FIR::Step(int new_sample)
{
#define Ntap 511

    static const float FIRCoef[Ntap] = {
        0.00000000000000027431,
        -0.00000000000000067142,
        -0.00000000000000017241,
        0.00000000000000002600,
        0.00000000000000057909,
        0.00000000000000031674,
        0.00000000000000172891,
        0.00000000000000063049,
        -0.00000000000000159594,
        -0.00000000000000001912,
        -0.00000000000000009323,
        -0.00000000000000070100,
        -0.00000000000000039443,
        -0.00000000000000040847,
        -0.00000000000000024592,
        -0.00000000000000020528,
        -0.00000000000000010877,
        0.00000000000000003078,
        0.00000000000000027670,
        -0.00000000000000061226,
        -0.00000000000000058776,
        -0.00000000000000021962,
        -0.00000000000000084652,
        0.00000000000000018855,
        0.00000000000000069443,
        -0.00000000000000041146,
        -0.00000000000000009084,
        -0.00000000000000016195,
        -0.00000000000000026534,
        -0.00000000000000010518,
        0.00000000000000054831,
        0.00000000000000062899,
        0.00000000000000220969,
        0.00000000000000034841,
        -0.00000000000000102880,
        -0.00000000000000001912,
        0.00000000000000144862,
        -0.00000000000000063108,
        -0.00000000000000068039,
        -0.00000000000000033735,
        0.00000000000000010727,
        0.00000000000000047929,
        -0.00000000000000050797,
        -0.00000000000000031674,
        -0.00000000000000500265,
        -0.00000000000000023785,
        -0.00000000000000525335,
        0.00000000000000080350,
        0.00000000000000031106,
        -0.00000000000000039443,
        0.00000000000000028357,
        0.00000000000000028566,
        -0.00000000000000054921,
        0.00000000000000129892,
        0.00000000000000064722,
        0.00000000000000343600,
        -0.00000000000000020468,
        0.00000000000000062302,
        -0.00000000000000026923,
        -0.00000000000000076226,
        -0.00000000000000034632,
        -0.00000000000000011743,
        -0.00000000000000010787,
        0.00000000000000015508,
        -0.00000000000000019393,
        0.00000000000000020409,
        0.00000000000000051350,
        -0.00000000000000071654,
        0.00000000000000067053,
        -0.00000000000000006529,
        -0.00000000000000031255,
        -0.00000000000000083323,
        -0.00000000000000120704,
        -0.00000000000000134852,
        0.00000000000000029089,
        -0.00000000000000030269,
        0.00000000000000047600,
        -0.00000000000000024652,
        -0.00000000000000080036,
        -0.00000000000000004228,
        -0.00000000000000049199,
        -0.00000000000000171561,
        0.00000000000000041684,
        0.00000000000000019184,
        -0.00000000000000030254,
        0.00000000000000078557,
        0.00000000000000008800,
        0.00000000000000019034,
        0.00000000000000065872,
        -0.00000000000000007933,
        -0.00000000000000024637,
        0.00000000000000077586,
        0.00000000000000046375,
        -0.00000000000000020005,
        -0.00000000000000005842,
        0.00000000000000003167,
        -0.00000000000000018227,
        -0.00000000000000018930,
        0.00000000000000068338,
        -0.00000000000000012759,
        0.00000000000000589355,
        -0.00000000000000018780,
        0.00000000000000073223,
        -0.00000000000000003645,
        -0.00000000000000000844,
        0.00000000000000019258,
        0.00000000000000025294,
        0.00000000000000028335,
        -0.00000000000000009913,
        -0.00000000000000263743,
        -0.00000000000000023793,
        -0.00000000000000022418,
        0.00000000000000005140,
        -0.00000000000000011795,
        -0.00000000000000008363,
        0.00000000000000002764,
        -0.00000000000000006118,
        -0.00000000000000010111,
        0.00000000000000072835,
        0.00000000000000038853,
        -0.00000000000000023593,
        0.00000000000000028247,
        -0.00000000000000004678,
        -0.00000000000000002968,
        0.00000000000000013315,
        -0.00000000000000022497,
        0.00000000000000021103,
        0.00000000000000049237,
        0.00000000000000006316,
        -0.00000000000000043604,
        -0.00000000000000014322,
        -0.00000000000000021509,
        -0.00000000000000004727,
        0.00000000000000005356,
        0.00000000000000043490,
        0.00000000000000005319,
        0.00000000000000072379,
        -0.00000000000000060879,
        -0.00000000000000046035,
        0.00000000000000017413,
        -0.00000000000000099268,
        -0.00000000000000005965,
        -0.00000000000000002981,
        -0.00000000000000029365,
        0.00000000000000028424,
        -0.00000000000000029410,
        -0.00000000000000018780,
        0.00000000000000001240,
        -0.00000000000000013469,
        -0.00000000000000031689,
        -0.00000000000000017951,
        -0.00000000000000019116,
        -0.00000000000000021253,
        -0.00000000000000001995,
        -0.00000000000000063093,
        0.00000000000000006648,
        0.00000000000000028447,
        -0.00000000000000005110,
        0.00000000000000029373,
        -0.00000000000000041280,
        -0.00000000000000022545,
        0.00000000000000013865,
        0.00000000000000018810,
        0.00000000000000100788,
        -0.00000000000000047421,
        0.00000000000000031450,
        -0.00000000000000009502,
        -0.00000000000000017421,
        0.00000000000000000941,
        -0.00000000000000071206,
        0.00000000000000074045,
        -0.00000000000000017824,
        0.00000000000000026743,
        -0.00000000000000007859,
        -0.00000000000000020289,
        -0.00000000000000006006,
        0.00000000000000027714,
        -0.00000000000000013357,
        -0.00000000000000007470,
        -0.00000000000000004542,
        -0.00000000000000003944,
        -0.00000000000000012535,
        0.00000000000000009158,
        -0.00000000000000009711,
        -0.00000000000000016599,
        0.00000000000000006395,
        -0.00000000000000003302,
        0.00000000000000080006,
        -0.00000000000000022844,
        -0.00000000000000012610,
        -0.00000000000000005050,
        -0.00000000000000012072,
        -0.00000000000000016524,
        -0.00000000000000000837,
        -0.00000000000000041385,
        -0.00000000000000006245,
        -0.00000000000000010608,
        0.00000000000000001255,
        -0.00000000000000045867,
        -0.00000000000000050140,
        0.00000000000000038188,
        0.00000000000000136436,
        -0.00000000000000223270,
        -0.00000000000000446569,
        0.00000000000000807411,
        0.00000000000001295724,
        -0.00000000000002836500,
        -0.00000000000003765406,
        0.00000000000010162807,
        0.00000000000010078693,
        -0.00000000000035709803,
        -0.00000000000025890147,
        0.00000000000123473968,
        0.00000000000059823414,
        -0.00000000000420834491,
        -0.00000000000110010252,
        0.00000000001415343121,
        0.00000000000068232365,
        -0.00000000004699703899,
        0.00000000000757264711,
        0.00000000015411405190,
        -0.00000000005737382714,
        -0.00000000049899975371,
        0.00000000029498315248,
        0.00000000159457518110,
        -0.00000000131475687627,
        -0.00000000502429111249,
        0.00000000543117941566,
        0.00000001558590334065,
        -0.00000002138959234459,
        -0.00000004748856463580,
        0.00000008150044497871,
        0.00000014159224260357,
        -0.00000030309129080491,
        -0.00000041067065463056,
        0.00000110650682107085,
        0.00000114689870539230,
        -0.00000398216278559648,
        -0.00000302561597578487,
        0.00001417493513620951,
        0.00000722922909182757,
        -0.00005005754857708174,
        -0.00001382483027145007,
        0.00017592494599760199,
        0.00000861927763055871,
        -0.00061767829956647013,
        0.00011198722622154533,
        0.00217863118775846270,
        -0.00093286709294774020,
        -0.00779309063633858500,
        0.00559692467643832430,
        0.02883191246316122900,
        -0.03272686436442752400,
        -0.11647112686728392000,
        0.27794060183696451000,
        0.68748960328973041000,
        0.27794060183696451000,
        -0.11647112686728392000,
        -0.03272686436442752400,
        0.02883191246316122900,
        0.00559692467643832430,
        -0.00779309063633858500,
        -0.00093286709294774020,
        0.00217863118775846270,
        0.00011198722622154533,
        -0.00061767829956647013,
        0.00000861927763055871,
        0.00017592494599760199,
        -0.00001382483027145007,
        -0.00005005754857708174,
        0.00000722922909182757,
        0.00001417493513620951,
        -0.00000302561597578487,
        -0.00000398216278559648,
        0.00000114689870539230,
        0.00000110650682107085,
        -0.00000041067065463056,
        -0.00000030309129080491,
        0.00000014159224260357,
        0.00000008150044497871,
        -0.00000004748856463580,
        -0.00000002138959234459,
        0.00000001558590334065,
        0.00000000543117941566,
        -0.00000000502429111249,
        -0.00000000131475687627,
        0.00000000159457518110,
        0.00000000029498315248,
        -0.00000000049899975371,
        -0.00000000005737382714,
        0.00000000015411405190,
        0.00000000000757264711,
        -0.00000000004699703899,
        0.00000000000068232365,
        0.00000000001415343121,
        -0.00000000000110010252,
        -0.00000000000420834491,
        0.00000000000059823414,
        0.00000000000123473968,
        -0.00000000000025890147,
        -0.00000000000035709803,
        0.00000000000010078693,
        0.00000000000010162807,
        -0.00000000000003765406,
        -0.00000000000002836500,
        0.00000000000001295724,
        0.00000000000000807411,
        -0.00000000000000446569,
        -0.00000000000000223270,
        0.00000000000000136436,
        0.00000000000000038188,
        -0.00000000000000050140,
        -0.00000000000000045867,
        0.00000000000000001255,
        -0.00000000000000010608,
        -0.00000000000000006245,
        -0.00000000000000041385,
        -0.00000000000000000837,
        -0.00000000000000016524,
        -0.00000000000000012072,
        -0.00000000000000005050,
        -0.00000000000000012610,
        -0.00000000000000022844,
        0.00000000000000080006,
        -0.00000000000000003302,
        0.00000000000000006395,
        -0.00000000000000016599,
        -0.00000000000000009711,
        0.00000000000000009158,
        -0.00000000000000012535,
        -0.00000000000000003944,
        -0.00000000000000004542,
        -0.00000000000000007470,
        -0.00000000000000013357,
        0.00000000000000027714,
        -0.00000000000000006006,
        -0.00000000000000020289,
        -0.00000000000000007859,
        0.00000000000000026743,
        -0.00000000000000017824,
        0.00000000000000074045,
        -0.00000000000000071206,
        0.00000000000000000941,
        -0.00000000000000017421,
        -0.00000000000000009502,
        0.00000000000000031450,
        -0.00000000000000047421,
        0.00000000000000100788,
        0.00000000000000018810,
        0.00000000000000013865,
        -0.00000000000000022545,
        -0.00000000000000041280,
        0.00000000000000029373,
        -0.00000000000000005110,
        0.00000000000000028447,
        0.00000000000000006648,
        -0.00000000000000063093,
        -0.00000000000000001995,
        -0.00000000000000021253,
        -0.00000000000000019116,
        -0.00000000000000017951,
        -0.00000000000000031689,
        -0.00000000000000013469,
        0.00000000000000001240,
        -0.00000000000000018780,
        -0.00000000000000029410,
        0.00000000000000028424,
        -0.00000000000000029365,
        -0.00000000000000002981,
        -0.00000000000000005965,
        -0.00000000000000099268,
        0.00000000000000017413,
        -0.00000000000000046035,
        -0.00000000000000060879,
        0.00000000000000072379,
        0.00000000000000005319,
        0.00000000000000043490,
        0.00000000000000005356,
        -0.00000000000000004727,
        -0.00000000000000021509,
        -0.00000000000000014322,
        -0.00000000000000043604,
        0.00000000000000006316,
        0.00000000000000049237,
        0.00000000000000021103,
        -0.00000000000000022497,
        0.00000000000000013315,
        -0.00000000000000002968,
        -0.00000000000000004678,
        0.00000000000000028247,
        -0.00000000000000023593,
        0.00000000000000038853,
        0.00000000000000072835,
        -0.00000000000000010111,
        -0.00000000000000006118,
        0.00000000000000002764,
        -0.00000000000000008363,
        -0.00000000000000011795,
        0.00000000000000005140,
        -0.00000000000000022418,
        -0.00000000000000023793,
        -0.00000000000000263743,
        -0.00000000000000009913,
        0.00000000000000028335,
        0.00000000000000025294,
        0.00000000000000019258,
        -0.00000000000000000844,
        -0.00000000000000003645,
        0.00000000000000073223,
        -0.00000000000000018780,
        0.00000000000000589355,
        -0.00000000000000012759,
        0.00000000000000068338,
        -0.00000000000000018930,
        -0.00000000000000018227,
        0.00000000000000003167,
        -0.00000000000000005842,
        -0.00000000000000020005,
        0.00000000000000046375,
        0.00000000000000077586,
        -0.00000000000000024637,
        -0.00000000000000007933,
        0.00000000000000065872,
        0.00000000000000019034,
        0.00000000000000008800,
        0.00000000000000078557,
        -0.00000000000000030254,
        0.00000000000000019184,
        0.00000000000000041684,
        -0.00000000000000171561,
        -0.00000000000000049199,
        -0.00000000000000004228,
        -0.00000000000000080036,
        -0.00000000000000024652,
        0.00000000000000047600,
        -0.00000000000000030269,
        0.00000000000000029089,
        -0.00000000000000134852,
        -0.00000000000000120704,
        -0.00000000000000083323,
        -0.00000000000000031255,
        -0.00000000000000006529,
        0.00000000000000067053,
        -0.00000000000000071654,
        0.00000000000000051350,
        0.00000000000000020409,
        -0.00000000000000019393,
        0.00000000000000015508,
        -0.00000000000000010787,
        -0.00000000000000011743,
        -0.00000000000000034632,
        -0.00000000000000076226,
        -0.00000000000000026923,
        0.00000000000000062302,
        -0.00000000000000020468,
        0.00000000000000343600,
        0.00000000000000064722,
        0.00000000000000129892,
        -0.00000000000000054921,
        0.00000000000000028566,
        0.00000000000000028357,
        -0.00000000000000039443,
        0.00000000000000031106,
        0.00000000000000080350,
        -0.00000000000000525335,
        -0.00000000000000023785,
        -0.00000000000000500265,
        -0.00000000000000031674,
        -0.00000000000000050797,
        0.00000000000000047929,
        0.00000000000000010727,
        -0.00000000000000033735,
        -0.00000000000000068039,
        -0.00000000000000063108,
        0.00000000000000144862,
        -0.00000000000000001912,
        -0.00000000000000102880,
        0.00000000000000034841,
        0.00000000000000220969,
        0.00000000000000062899,
        0.00000000000000054831,
        -0.00000000000000010518,
        -0.00000000000000026534,
        -0.00000000000000016195,
        -0.00000000000000009084,
        -0.00000000000000041146,
        0.00000000000000069443,
        0.00000000000000018855,
        -0.00000000000000084652,
        -0.00000000000000021962,
        -0.00000000000000058776,
        -0.00000000000000061226,
        0.00000000000000027670,
        0.00000000000000003078,
        -0.00000000000000010877,
        -0.00000000000000020528,
        -0.00000000000000024592,
        -0.00000000000000040847,
        -0.00000000000000039443,
        -0.00000000000000070100,
        -0.00000000000000009323,
        -0.00000000000000001912,
        -0.00000000000000159594,
        0.00000000000000063049,
        0.00000000000000172891,
        0.00000000000000031674,
        0.00000000000000057909,
        0.00000000000000002600,
        -0.00000000000000017241,
        -0.00000000000000067142,
        0.00000000000000027431
    };

    static float x[Ntap];   //input samples
    float y = 0.0;            //output sample
    int n;

    //shift the old samples
    for (n = Ntap - 1; n > 0; n--)
        x[n] = x[n - 1];

    //Calculate the new output
    x[0] = (float)new_sample;
    for (n = 0; n < Ntap; n++)
        y += FIRCoef[n] * x[n];

    return (int)y;
}
